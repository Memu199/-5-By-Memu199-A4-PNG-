<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>بطاقات (وجه يسار / ظهر يمين) → PNG A4 مع قص وقالب بطاقة (بدون كاميرا)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- CropperJS (قص فقط) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

<style>
  .thumb{object-fit:contain;background:#fff}
  .modal-bg{background:rgba(0,0,0,.65)}
  .template-frame{
    position:absolute; inset:0; pointer-events:none;
    display:flex; align-items:center; justify-content:center;
  }
  .frame-box{
    border:3px dashed rgba(0,0,0,.7); border-radius:10px;
    /* نسبة بطاقة الهوية القياسية: 85.6 × 54 مم ≈ 1.586 */
    aspect-ratio: 1.586;
    width:min(85%, 520px);
    box-shadow: 0 0 0 9999px rgba(0,0,0,.18) inset;
  }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem 1rem; border-radius:0.75rem }
</style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">
<div class="max-w-5xl mx-auto p-4 sm:p-6">

  <header class="mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold">تجهيز 5 بطاقات ناخب (By:@Memu199) ثم حفظ صورة A4 (PNG)</h1>
    <p class="mt-2 text-sm text-slate-600">
      لكل صف: <b>الوجه يسار</b> و<b>الظهر يمين</b>. أضف الصورة لكل خانة، ثم استخدم ✂️ للقص مع <b>قالب بطاقة</b> لتطابق الإطار.
    </p>
  </header>

  <!-- إعدادات عامة -->
  <section class="bg-white rounded-2xl shadow p-4 mb-6">
    <div class="grid sm:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">هامش الصفحة (مم)</label>
        <input id="marginMm" type="number" min="0" max="20" step="1" value="8" class="w-full rounded-xl border-slate-300"/>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">مسافة بين الخلايا (مم)</label>
        <input id="gutterMm" type="number" min="0" max="10" step="1" value="3" class="w-full rounded-xl border-slate-300"/>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">دقّة A4 (DPI)</label>
        <input id="dpi" type="number" min="72" max="400" step="1" value="300" class="w-full rounded-xl border-slate-300"/>
      </div>
    </div>
    <div class="mt-3 flex flex-wrap gap-2">
      <button id="savePng" class="btn bg-emerald-600 text-white hover:bg-emerald-700">حفظ كصورة PNG (A4)</button>
      <button id="clearAll" class="btn bg-slate-200 hover:bg-slate-300">مسح الكل</button>
    </div>
    <p id="status" class="mt-2 text-sm text-slate-500"></p>
  </section>

  <!-- الشبكة 5 × 2: الوجه يسار / الظهر يمين -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-4">شبكة الإدخال: 5 صفوف × 2 (الوجه يسار / الظهر يمين)</h2>
    <div class="grid grid-cols-2 gap-4">
      <div id="slots" class="col-span-2 grid grid-cols-2 gap-4"></div>
    </div>
  </section>
</div>

<!-- نافذة القص -->
<div id="cropModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl overflow-hidden">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div class="font-semibold">قص الصورة</div>
      <div class="flex items-center gap-2">
        <button id="toggleTemplate" class="btn bg-slate-200 hover:bg-slate-300">قالب بطاقة</button>
        <button id="closeModal" class="btn bg-slate-200 hover:bg-slate-300">إلغاء</button>
      </div>
    </div>
    <div class="p-3">
      <div class="relative bg-slate-100 rounded-xl overflow-hidden" style="aspect-ratio: 16/9;">
        <img id="cropImage" class="w-full h-full object-contain"/>
        <!-- طبقة إطار البطاقة -->
        <div id="tplOverlay" class="template-frame hidden">
          <div class="frame-box"></div>
        </div>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <button id="fitToTemplate" class="btn bg-slate-200 hover:bg-slate-300">مطابقة إطار القالب</button>
        <div class="ms-auto"></div>
        <button id="confirmCrop" class="btn bg-emerald-600 text-white hover:bg-emerald-700">موافق</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= ثوابت ========= */
const ROWS=5, COLS=2;           // 10 خانات: الوجه (يسار) = col 0, الظهر (يمين) = col 1
const ID_ASPECT=1.586;          // نسبة أبعاد بطاقة الهوية (عرض/ارتفاع)

/* ========= عناصر DOM ========= */
const slotsWrap=document.getElementById('slots');
const statusEl=document.getElementById('status');
const saveBtn=document.getElementById('savePng');
const clearBtn=document.getElementById('clearAll');

const marginEl=document.getElementById('marginMm');
const gutterEl=document.getElementById('gutterMm');
const dpiEl   =document.getElementById('dpi');

/* قص */
const cropModal=document.getElementById('cropModal');
const cropImg=document.getElementById('cropImage');
const closeModal=document.getElementById('closeModal');
const confirmCrop=document.getElementById('confirmCrop');
const toggleTemplate=document.getElementById('toggleTemplate');
const tplOverlay=document.getElementById('tplOverlay');
const fitToTemplate=document.getElementById('fitToTemplate');

let cropper=null, resolveCrop, rejectCrop;

/* ========= بيانات ========= */
const dataURLs=new Array(ROWS*COLS).fill(null); // الناتج المقصوص النهائي لكل خانة

function note(t){ statusEl.textContent=t; }

/* ========= بناء الشبكة ========= */
for(let r=0;r<ROWS;r++){
  for(let c=0;c<COLS;c++){
    const idx=r*COLS+c;
    slotsWrap.appendChild(makeSlot(idx,r,c));
  }
}

function makeSlot(idx,r,c){
  const card=document.createElement('div');
  card.className='border border-slate-200 rounded-xl p-3 flex flex-col gap-2';

  const title=document.createElement('div');
  title.className='text-sm text-slate-600';
  title.innerHTML=`بطاقة ${r+1} — ${c===0?'<b>الوجه (يسار)</b>':'<b>الظهر (يمين)</b>'}`;
  card.appendChild(title);

  const previewWrap=document.createElement('div');
  previewWrap.className='relative bg-slate-50 rounded-lg border overflow-hidden';
  previewWrap.style.height='170px';

  const img=document.createElement('img');
  img.className='thumb w-full h-full'; img.style.display='none';
  previewWrap.appendChild(img);

  // زر قص ✂️ يظهر فقط عند وجود صورة
  const cropBtn=document.createElement('button');
  cropBtn.title='قص الصورة';
  cropBtn.textContent='✂️';
  cropBtn.className='hidden absolute top-2 start-2 w-9 h-9 rounded-full bg-slate-800 text-white hover:bg-slate-700';
  cropBtn.addEventListener('click', async ()=>{
    if(!dataURLs[idx]) return;
    try{
      const updated=await openCropperOnDataURL(dataURLs[idx]);
      dataURLs[idx]=updated; img.src=updated; note('تم تعديل القص.');
    }catch(e){/* إلغاء */}
  });
  previewWrap.appendChild(cropBtn);

  // زر حذف ×
  const delBtn=document.createElement('button');
  delBtn.textContent='×';
  delBtn.title='حذف الصورة';
  delBtn.className='hidden absolute top-2 end-2 w-9 h-9 rounded-full bg-rose-600 text-white hover:bg-rose-700';
  delBtn.addEventListener('click',()=>{
    dataURLs[idx]=null; img.src=''; img.style.display='none';
    delBtn.classList.add('hidden'); pickBtn.classList.remove('hidden'); cropBtn.classList.add('hidden');
    note(`تم حذف صورة خانة ${r+1}-${c===0?'الوجه':'الظهر'}.`);
  });
  previewWrap.appendChild(delBtn);

  card.appendChild(previewWrap);

  // زر اختيار/التقاط (من المعرض/الكاميرا القياسية عبر input)
  const pickBtn=document.createElement('label');
  pickBtn.className='btn bg-slate-800 text-white hover:bg-slate-700';
  pickBtn.textContent='التقاط/اختيار صورة';
  card.appendChild(pickBtn);

  const input=document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment'; input.className='hidden';
  pickBtn.appendChild(input);

  input.addEventListener('change', async (e)=>{
    const file=e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const out=await openCropperOnFile(file);     // افتح القص مباشرة بعد الالتقاط/الاختيار
      dataURLs[idx]=out; img.src=out; img.style.display='';
      pickBtn.classList.add('hidden'); delBtn.classList.remove('hidden'); cropBtn.classList.remove('hidden');
      note(`تمت إضافة صورة لبطاقة ${r+1} (${c===0?'الوجه':'الظهر'}).`);
    }catch(err){
      // أُلغي
    }finally{
      input.value='';
    }
  });

  return card;
}

/* ========= منطق القص (أداة قص فقط) ========= */
function openCropperOnFile(file){
  return new Promise((resolve,reject)=>{
    const rd=new FileReader();
    rd.onload=e=>{ openCropper(e.target.result).then(resolve).catch(reject); };
    rd.onerror=reject; rd.readAsDataURL(file);
  });
}
function openCropperOnDataURL(dataURL){ return openCropper(dataURL); }

function openCropper(dataURL){
  return new Promise((resolve,reject)=>{
    resolveCrop=resolve; rejectCrop=reject;
    cropImg.src=dataURL;
    showCropModal();
  });
}

function showCropModal(){
  cropModal.classList.remove('hidden');
  setTimeout(()=>{
    cropper?.destroy();
    cropper=new Cropper(cropImg,{
      viewMode:1, background:false, autoCropArea:1,
      movable:true, zoomable:true, scalable:false, rotatable:false,
      aspectRatio: ID_ASPECT // إجبار نسبة بطاقة
    });
  },50);
}
function hideCropModal(){ cropper?.destroy(); cropper=null; cropModal.classList.add('hidden'); }

toggleTemplate.addEventListener('click',()=>{
  tplOverlay.classList.toggle('hidden');
});

fitToTemplate.addEventListener('click',()=>{
  if(!cropper) return;
  // تكبير صندوق القص ليتوافق مع الإطار ويتمركز
  const c=cropper.getContainerData();
  const targetW=c.width*0.85, targetH=targetW/ID_ASPECT;
  cropper.setData({ width: targetW, height: targetH });
  const b=cropper.getCropBoxData();
  cropper.setCropBoxData({ left:(c.width-targetW)/2, top:(c.height-targetH)/2, width:targetW, height:targetH });
});

closeModal.addEventListener('click',()=>{ hideCropModal(); rejectCrop?.('cancel'); });
confirmCrop.addEventListener('click',()=>{
  if(!cropper) return;
  const canvas=cropper.getCroppedCanvas({ imageSmoothingEnabled:true, imageSmoothingQuality:'high' });
  const dataURL=canvas.toDataURL('image/jpeg',0.95);
  hideCropModal(); resolveCrop?.(dataURL);
});

/* ========= حفظ كـ PNG (A4) ========= */
function mmToPx(mm, dpi){ const inch=mm/25.4; return Math.round(inch*dpi); }
function loadImage(dataURL){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=dataURL; }); }
function drawFitted(ctx, img, x, y, w, h){
  const arImg=img.naturalWidth/img.naturalHeight, arCell=w/h;
  let dw, dh; if(arImg>arCell){ dw=w; dh=dw/arImg; } else { dh=h; dw=dh*arImg; }
  const dx=x + (w-dw)/2, dy=y + (h-dh)/2;
  ctx.drawImage(img, dx, dy, dw, dh);
}

saveBtn.addEventListener('click', async ()=>{
  if(!dataURLs.some(Boolean)){ note('أضف صوراً أولاً.'); return; }

  const dpi = Math.max(72, Math.min(400, Number(dpiEl.value)||300));
  const A4mm = { w:210, h:297 };
  const W = mmToPx(A4mm.w, dpi), H = mmToPx(A4mm.h, dpi);

  const margin = Math.max(0, Number(marginEl.value)||0);
  const gutter = Math.max(0, Number(gutterEl.value)||0);

  const marginPx = mmToPx(margin, dpi);
  const gutterPx = mmToPx(gutter, dpi);

  const cols=COLS, rows=ROWS;
  const cellW = Math.floor((W - 2*marginPx - (cols-1)*gutterPx)/cols);
  const cellH = Math.floor((H - 2*marginPx - (rows-1)*gutterPx)/rows);

  const cvs=document.createElement('canvas'); cvs.width=W; cvs.height=H;
  const ctx=cvs.getContext('2d');
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H); // خلفية بيضاء

  try{
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const idx=r*cols+c; const d=dataURLs[idx]; if(!d) continue;
        const img=await loadImage(d);
        const x = marginPx + c*(cellW+gutterPx);
        const y = marginPx + r*(cellH+gutterPx);
        drawFitted(ctx, img, x, y, cellW, cellH);
      }
    }
    const url=cvs.toDataURL('image/png');
    const a=document.createElement('a'); a.href=url; a.download='A4-cards.png';
    document.body.appendChild(a); a.click(); a.remove();
    note('تم حفظ صورة A4 بصيغة PNG ✅');
  }catch(e){
    console.error(e);
    note('تعذّر إنشاء الصورة. تأكد من الأذونات وحجم الصور.');
  }
});

/* ========= مسح الكل ========= */
clearBtn.addEventListener('click', ()=>{
  for(let i=0;i<dataURLs.length;i++) dataURLs[i]=null;
  slotsWrap.innerHTML='';
  for(let r=0;r<ROWS;r++){ for(let c=0;c<COLS;c++){ const idx=r*COLS+c; slotsWrap.appendChild(makeSlot(idx,r,c)); } }
  note('تم المسح.');
});
</script>
</body>
</html>